// ==UserScript==
// @name         soundcloud 0.1
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @downloadURL  https://raw.githubusercontent.com/yeucodonvn/codejs/master/tamperkey-soundcloud.js
// @downloadURL  https://raw.githubusercontent.com/yeucodonvn/codejs/master/tamperkey-soundcloud.js
// @match        https://soundcloud.com/*
// @require 	 https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js
// @run-at       document-idle
// @grant        unsafeWindow
// ==/UserScript==

// Inject script vào page context để bypass detection
function injectScript(func) {
	const script = document.createElement('script');
	script.textContent = '(' + func.toString() + ')();';
	(document.head || document.documentElement).appendChild(script);
	script.remove();
}

// Script sẽ chạy trong page context
function pageScript() {
	'use strict';
	var URLsc;
	var LocalStorageKey = "urlSoundcloud";
	var temp_number = 200;

	// $.ajax ( {
	// 	type:       'GET',
	// 	url:        'https://raw.githubusercontent.com/yeucodonvn/codejs/master/URL.json',
	// 	dataType:   'JSON',
	// 	success:    function (apiJSON) {
	// 		let PARAMS = apiJSON;
	// 		URLsc=PARAMS.soundcloud;
	// 	},
	// 	error:      function(err){
	// 		alert("Cannot load JSON file");
	// 		alert(err);
	// 	}
	// });

	function play_btn() {
		checkstop();
		var loopClickRepeat = setInterval(function () {
			let element = document.querySelector('section.playControls__inner');
			if (element !== null) {
				clearInterval(loopClickRepeat);
				setTimeout(shuffle, 10000);
				setTimeout(repeatpp, 1000)
			} else {
				console.log("search play btn");
			}
		}, 5000);
	};
	// Hàm click giống người dùng thật
	function humanClick(element) {
		const rect = element.getBoundingClientRect();
		const x = rect.left + rect.width / 2;
		const y = rect.top + rect.height / 2;

		// Dispatch các event giống click thật
		['mousedown', 'mouseup', 'click'].forEach(eventType => {
			const event = new MouseEvent(eventType, {
				view: window,
				bubbles: true,
				cancelable: true,
				clientX: x,
				clientY: y,
				button: 0
			});
			element.dispatchEvent(event);
		});
	}

	function checkstop() {
		// Đợi element xuất hiện trước khi bắt đầu check
		let waitForElement = setInterval(function() {
			let element = document.querySelector('.soundTitle__playButton>[role="button"][title="Play"]');
			if (element != null) {
				console.log('Element found, start monitoring...');
				clearInterval(waitForElement);

				// Bắt đầu check mỗi 5 giây
				setInterval(function () {
					let element = document.querySelector('.soundTitle__playButton>[role="button"][title="Play"]');
					if (element != null) {
						console.log('click play');
						humanClick(element);
					}
				}, 5000);
			} else {
				console.log('Waiting for play button...');
			}
		}, 1000); // Check mỗi giây cho đến khi tìm thấy
	}
	function SetLocalStorage(key, value) {
		localStorage.setItem(key, value);
		console.log('Đã lưu "' + key + '" vào localStorage.');

		// Xóa dữ liệu
		// localStorage.removeItem('tenNguoiDung');
		// console.log('Đã xóa "tenNguoiDung" khỏi localStorage.');
	}
	function repeatpp() {
		let intload = 0;
		let loop = setInterval(function () {
			let element = document.querySelector(".repeatControl");
			if (!element.classList.contains('m-all')) {
				console.log("click repeat");
				humanClick(element);
			} else { clearInterval(loop); }
			if (intload > 7) { clearInterval(loop) }
		}, 1000)

	};
	function shuffle() {
		var element = document.querySelector('button.shuffleControl');
		if (!element.classList.contains('m-shuffling')) {
			console.log("click shuffle");
			humanClick(element);
		}
	};

	function clickLike() {
		let loopClickLikeRepeat = setInterval(function () {
			let btnRender = document.querySelector('[aria-label="Like"]');
			if (btnRender != null) {
				if (Math.floor(Math.random() * 125) > 100) {
					console.log("Like Click");
					btnRender.click();
				}
				clearInterval(loopClickLikeRepeat);
			}
		}, 100 * 1000);
	}

	function clickFollow() {
		let loopClickLikeRepeat = setInterval(function () {
			let btnRender = document.querySelector('[aria-label="Follow"]');
			if (btnRender != null) {
				if (Math.floor(Math.random() * 105) > 100) {
					console.log("Like Click");
					btnRender.click();
				}
				clearInterval(loopClickLikeRepeat);
			}
		}, 100 * 1000);
	}

	function run() {
		console.log("SOUNDCLOUD AutoPlay - MANAGER - Repeat Number " + temp_number);
		let url = localStorage.getItem(LocalStorageKey);
		if (url == null || url == "" || url == "undefined") {
			url = prompt("Nhập URL Soundcloud", "https://soundcloud.com/marilyncortez/sets/melodies-from-beyond-1");
			SetLocalStorage(LocalStorageKey, url);
			console.log("Chuyển hướng đến URL: " + url);
			window.location.href = url;
		}
		else {
			let curl = window.location.href;
			if (curl.includes(url)) {
				setTimeout(play_btn, 20000);
			}
			else
				setTimeout(function () {
					window.location.href = url;
				}, 10000);
		}

	};

	setTimeout(run, 5000);
}

// Inject script vào page context
injectScript(pageScript);
